- name: Install MariaDB repository
  apt_repository: repo='deb http://ftp.igh.cnrs.fr/pub/mariadb/repo/10.0/ubuntu trusty main' state=present
  when: is_ubuntu

- name: Add repository key to the system
  apt_key: keyserver=keyserver.ubuntu.com id=0xcbcb082a1bb943db
  when: is_ubuntu

- name: Install MariaDB Server
  apt: name=mariadb-server state=latest update_cache=yes
  when: is_ubuntu

- name: Configure MariaDB
  template: src=../config/mysql/my.cnf.j2 dest=/etc/mysql/conf.d/my.cnf
  notify: restart mysql
  when: is_ubuntu


# MACOS
# -----
- name: Install MariaDB Server
  homebrew: name=mariadb
  when: is_osx

- name: Install database
  command: sh mysql_install_db
  
- name: Start mysql
  command: sh mysql.server start
  
- name: Configure MariaDB
  # template: src=~/dotfiles/config/mysql/my.cnf.j2 dest=/usr/local/etc/my.cnf mode=0644  
  # template: src=my.cnf.j2 dest=/usr/local/etc/my.cnf
  template: src=my.cnf.j2 dest=~/aaaaaaaaaaaa.cnf
  when: is_osx


# COMMON
# ------
# - name: Start and enable service
#   service: name=mariadb state=started enabled=yes

# - name: Reload privilege tables
#   command: 'mysql -ne "{{ item }}"'
#   with_items:
#     - FLUSH PRIVILEGES
#   changed_when: false

# - name: Remove anonymous users
#   command: 'mysql -ne "{{ item }}"'
#   with_items:
#     - DELETE FROM mysql.user WHERE User=''
#   changed_when: false

# - name: Disallow root login remotely
#   command: 'mysql -ne "{{ item }}"'
#   with_items:
#     - DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1')
#   changed_when: false

# - name: Remove test database and access to it
#   command: 'mysql -ne "{{ item }}"'
#   with_items:
#     - DROP DATABASE test
#     - DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%'
#   changed_when: false
#   ignore_errors: true

# - name: Reload privilege tables
#   command: 'mysql -ne "{{ item }}"'
#   with_items:
#     - FLUSH PRIVILEGES
#   changed_when: false
